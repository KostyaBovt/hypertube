
// var request_data = [{"hash":"EA3543F8AFDB2523124549C1A8ABEABB37439D03","resolution":720,"imdb_id":"tt0047396"},{"hash":"12BC64FC7688661AC370EA644DAF35285C728030","resolution":1080,"imdb_id":"tt0047396"},{"hash":"801264BC5DE4181C4C6686B4B0D15B7F395F48C2","resolution":720,"imdb_id":"tt1675434"},{"hash":"4BDCB593DAC54B2E78F710BF4E3E78349148A70B","resolution":1080,"imdb_id":"tt1675434"},{"hash":"B55CAB44BCE1941094514D675D71603EEC15201C","resolution":720,"imdb_id":"tt5074352"},{"hash":"046D19A39F673A6ED2775E995CB98BB95095AAD7","resolution":1080,"imdb_id":"tt5074352"},{"hash":"63F3EFA4AD30DB47F3719FFDDD63F74E5CB352B6","resolution":720,"imdb_id":"tt0078788"},{"hash":"380CBECBD78723DEA6305DE0ABC6ED22CEACF4E8","resolution":1080,"imdb_id":"tt0078788"},{"hash":"86C0F185B54C30DE6CC276B96CF6B762692EAEDF","resolution":720,"imdb_id":"tt0095327"},{"hash":"B8AEFDBC4D06B2F69829F8A091A01D60E3A7886C","resolution":1080,"imdb_id":"tt0095327"},{"hash":"E559BA8F19F536CD6F0F9FDA134A250226676F8F","resolution":720,"imdb_id":"tt0095765"},{"hash":"2BDE57B55E9D63E75502A6AA9C76DC1FF1499097","resolution":1080,"imdb_id":"tt0095765"},{"hash":"F2B151672222C47A2FA155BD4A5E77879E9CC3F4","resolution":720,"imdb_id":"tt0043014"},{"hash":"18561F7F5AF35A9A9F4F24AD9748340B5CC1EC60","resolution":1080,"imdb_id":"tt0043014"},{"hash":"0264F5F0A914D1E2DA722657F51DCFF9B6FC11A6","resolution":720,"imdb_id":"tt1313104"},{"hash":"C3D22F0CD00899B0D8AAC6C72ECC3F092F92F5BA","resolution":1080,"imdb_id":"tt1313104"},{"hash":"C45EF19AE61E85AEFF84305FE9F5D00EAE8DB380","resolution":720,"imdb_id":"tt7681902"},{"hash":"A362FFC7F875A627B0993B40202BC5AE5CA5A4DB","resolution":1080,"imdb_id":"tt7681902"},{"hash":"FDB22F549664039473B1B3738100C2E1E50B581A","resolution":720,"imdb_id":"tt7610196"},{"hash":"8752BA2BCD452F0F8F497CA55A130DFE93274967","resolution":1080,"imdb_id":"tt7610196"},{"hash":"CB2342B6B84343147CB46FBD5263EFC6C481A372","resolution":720,"imdb_id":"tt0090605"},{"hash":"25DA5C0B1D5DB01009716F31481D89F7419B06C9","resolution":1080,"imdb_id":"tt0090605"},{"hash":"C894CB6E985E937936B52F638B546F9B080024CC","resolution":720,"imdb_id":"tt0169547"},{"hash":"783FE3217B56242360448767CCD3967D209556B3","resolution":1080,"imdb_id":"tt0169547"},{"hash":"CD7B33B9A29EA45BB52C93D528E6C9AEAB88022A","resolution":720,"imdb_id":"tt2166834"},{"hash":"25B202358F376147364C328F04846DB56BE94DC3","resolution":1080,"imdb_id":"tt2166834"},{"hash":"8ABFCC6E88DBDF86DD06A02F62CE3193193FF57A","resolution":720,"imdb_id":"tt0112573"},{"hash":"125E66ECD5346CBDBD7AAE72BEF93651712877A9","resolution":1080,"imdb_id":"tt0112573"},{"hash":"40B3232ECA07E475C9FCD3DF397FFDC19031EA16","resolution":720,"imdb_id":"tt0033467"},{"hash":"21C1AC1B69FDE8BFFDD301970A8B571F13AEF500","resolution":1080,"imdb_id":"tt0033467"},{"hash":"C808185A43F255625E639F65E3E57DEDD5353BD1","resolution":720,"imdb_id":"tt1853728"},{"hash":"5A33FE6305951A420CA30A6A5FF2E48C6FB4C7F1","resolution":1080,"imdb_id":"tt1853728"},{"hash":"E19C6EE07D46F2AC7FFF18EAADE16613BF6800C5","resolution":720,"imdb_id":"tt0057012"},{"hash":"11BCF7CC11CE1306EE6EBB796EEADD23B8C73114","resolution":1080,"imdb_id":"tt0057012"},{"hash":"1214F60971176EAEDA7154597BCE9DBDFC52A212","resolution":720,"imdb_id":"tt0087843"},{"hash":"0BD2EAC1746A0915645F3DEE185433F1D5C050D2","resolution":1080,"imdb_id":"tt0087843"},{"hash":"7708C5B4AC18E65AA4B1461C88ECF6C14C2E0B9C","resolution":720,"imdb_id":"tt0050825"},{"hash":"88A182593F705C49F5A2B69D74A03654030F1F7C","resolution":1080,"imdb_id":"tt0050825"},{"hash":"A681659FF2779A2768430E9E3774840550BC4C7F","resolution":720,"imdb_id":"tt0119698"},{"hash":"640A456000004C505A4848D66803A34B71AE002F","resolution":1080,"imdb_id":"tt0119698"},{"hash":"CAEBDB751F2B541C9A420A15FB5C107494544285","resolution":720,"imdb_id":"tt1345836"},{"hash":"FBC4BEED6422187F34556C5C0AD2473E4D2E5C18","resolution":1080,"imdb_id":"tt1345836"},{"hash":"DA5F846ABF1755E78C67E191F49D5A2948BF1299","resolution":720,"imdb_id":"tt0081505"},{"hash":"8C58874899B2BA718A1741266AB9FB198934D941","resolution":1080,"imdb_id":"tt0081505"},{"hash":"859187A8AB16513F7540FD75DFC824E209FCBE37","resolution":720,"imdb_id":"tt0082096"},{"hash":"5F0D1B0BDF415962649F4036C99D5A10D69D669A","resolution":1080,"imdb_id":"tt0082096"},{"hash":"C637D6ABB988BF06BB9D02322DB66C47E027DCE7","resolution":720,"imdb_id":"tt0910970"},{"hash":"6687A51BB38802620E13542D9C50235039F939D1","resolution":1080,"imdb_id":"tt0910970"},{"hash":"801E6EE764B1C34FA4D4D150868154E74FF82937","resolution":720,"imdb_id":"tt0060345"},{"hash":"E17C26153FAC8FA0BE33F3ACEC087B386B1F415B","resolution":1080,"imdb_id":"tt0060345"},{"hash":"E350370E8640F1E3537E514B19A4E23D6375E572","resolution":720,"imdb_id":"tt2380307"},{"hash":"BA625AD4538EB9520341F989FBA78E69FD2458EC","resolution":1080,"imdb_id":"tt2380307"},{"hash":"DAF91144F7D11AC2ACF76C43E2F97716582EC509","resolution":720,"imdb_id":"tt5311514"},{"hash":"4DCDDD6DEB6FDE94DAE41F9991FE4223C30972E8","resolution":1080,"imdb_id":"tt5311514"},{"hash":"1F2DADFE2F4F1BDD56BF71E3F475122A66644A58","resolution":720,"imdb_id":"tt0405094"},{"hash":"27D03C054E00C5535AEEC1FBAD6BD6769A9A0715","resolution":1080,"imdb_id":"tt0405094"},{"hash":"BBEEFB1802346CEA31EE4CF1F0B58FB6504F28E1","resolution":720,"imdb_id":"tt0022100"},{"hash":"D9BCB4917F2C21D84623000D82450A8CBDA0F12F","resolution":1080,"imdb_id":"tt0022100"},{"hash":"F9AEAF46F269183180D95BB8B236F1102C2FF7CB","resolution":720,"imdb_id":"tt0051201"},{"hash":"D3DFE3DE121AB7C14D1A872AA0539A24426958FC","resolution":1080,"imdb_id":"tt0051201"}];


// var string_sql = 'insert into popular_films values ';

// for (var i = request_data.length - 1; i >= 0; i--) {
// 	let count = Math.floor(Math.random() * 100) + 1;
// 	let imdb_id = request_data[i]['imdb_id'];
// 	let values = "('" + imdb_id + "', " + count + ")," ;
// 	if (request_data[i]['resolution'] == 720) {
// 		string_sql += values;
// 	}
// }

// console.log(string_sql);

//======================================

// var rimraf = require('rimraf');

// rimraf('/tmp/videos/tt0051201', function () { 
// 	console.log('====\ndeleted folder /tmp/videos/tt0051201\n=========\n');
// });

// const {Client}  = require('pg');

// const db = new Client({
//   user: 'Hypertube',
//   host: 'localhost',
//   database: 'Hypertube',
//   password: '12345',
//   port: 5433,
// });

// await db.connect()

// const res = await db.query( "SELECT * from popular_films where  NOW() - last_seen > INTERVAL '164  minutes'");
// for (var i = res.rows.length - 1; i >= 0; i--) {
// 	console.log('now to delete this film :');
// 	console.log(res.rows[i]['imdb_id']);
// }
// await db.end()

//======================================


const imdb_id = 'tt0047396';

const axios 	= require('axios');
const srt2vtt = require('srt-to-vtt');
const fs 		= require('fs');

const OpenSubtitles = require('opensubtitles-api');
const OS = new OpenSubtitles({
	useragent: "Hypertube v1",
	username: "hypertube_optimus",
	password: "33cats44dogs",
	ssl: true
});


async function downloadSubtitles_sub(url, name) {

  const path_vtt = '/tmp/' + name + '.vtt';

  // axios image download with response type "stream"
  const response = await axios({
    method: 'GET',
    url: url,
    responseType: 'stream'
  })

  // pipe the result stream into a file on disc
  // response.data.pipe(fs.createWriteStream(path_srt));
  response.data.pipe(srt2vtt()).pipe(fs.createWriteStream(path_vtt));

  // return a promise and resolve when download finishes
  return new Promise((resolve, reject) => {
    response.data.on('end', () => {
      resolve()
    })

    response.data.on('error', () => {
      reject()
    })
  })

}

(async function() {
	OS.search({
		imdbid: imdb_id
	}).then(async (result) => {
		console.log(result);

		var locales = ['ru', 'en'];

		var arrayLength = locales.length;
		for (var i = 0; i < arrayLength; i++) {
			if (result[locales[i]]) {
				var url  = result[locales[i]]['url'];
				var name = imdb_id + '_' + locales[i];
				await downloadSubtitles_sub(url, name);
				console.log('downloaded subs: ' + name);
				// var list_files = walkSync(dir_path_subs);
				// console.log('we have such subs files:');
				// console.log(list_files);
			}
		}
	})
	
})();


